# 分布式事务
- XA协议(两阶段提交、三阶段提交)


- TCC （两阶段型、补偿型）
- 最大努力通知（非可靠消息 、定期校对）
- 可靠消息最终一致（异步确何型）
-----------

## XA协议两阶段提交
#### 角色
> 中心单点协调者、分节点多参与者

#### 流程
> 第一阶段：协调者通知各参与者准备，各参与者锁住资源，执行操作并记入undo、redo，等待协调者 第二阶段通知后提交
第二阶段：协调者收到所有参与者发回的反馈信息，如果都是Done则通知 各参与者 提交事务；如果不都是Done则通知 各参与者回滚事务；

- 第一阶段
 ![](/assets/640.webp)

- 第二阶段
![](/assets/641.webp)


#### 不足
- 性能问题
- 协调者单点故障问题
- 丢失消息导致的不一致问题


#### 性能问题
第一阶段后 各参与者 锁住资源，等待提交
只有当所有参与者准备完毕，事务协调者才会通知提交，参与者提交后才会释放资源，造成性能问题

#### 协调者单点故障问题
一旦事务协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务

#### 丢失消息导致的不一致问题
发生局部网络问题，一部分事务参与者收到了提交消息，另一部分事务参与者没收到提交消息，那么就导致了节点之间数据的不一致

-----------


## XA三阶段提交

XA三阶段提交在两阶段提交的基础上增加了CanCommit阶段，并且引入了超时机制。
一旦参与者迟迟没有接到协调者的commit请求，会自动进行本地commit
这样有效解决了协调者单点故障的问题，但是性能问题和不一致的问题仍然没有根本解决

-----------

## XA两阶段提交 VS 三阶段提交 总结
> 两阶段提交如果中心协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务
> 三阶段提交引入了CanCommit阶段和超时机制，解决了上面中心协调者节点挂掉








## TCC
TCC事务是Try、Commit、Cancel三种指令的缩写，其逻辑模式类似于XA两阶段提交，但是实现方式是在代码层面来人为实现
TCC里对每个服务资源操作的是本地事务，数据被lock的时间短，可扩展性好

## 最大努力通知
#### 方案特点
• 业务活动的主动方在完成业务处理后，向业务活动被动方发送通知消息（允许消息丢失）
• 主动方可以设置时间阶梯型通知规则，在通知失败后按规则重复通知，直到通知N次后不再通知
• 主动方提供校对查询接口给被动方按需校对查询，用于恢复丢失的业务消息
#### 行业应用案例
• 银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对账文件）




# 分布式可靠消息

![](/assets/hello.PNG)

有两个问题：1.消息状态确认 2.消息恢复
轮询从业务方读取状态并更新


![](/assets/shiwu.PNG)

我的文档：第40： 2017年7月最新微服务架构的分布式事务解决方案价值1399


# 分布式最大努力型
也就是将可靠消息的 （请求发送、确认发送、取消发送）部分 替换为 在业务处理服务的本地数据库消息表中，其他消息确认系统，和消息恢复（定时检查）不变