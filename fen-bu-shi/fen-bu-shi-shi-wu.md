![](/assets/v2-079e51cc1d398c96a8d321d0653d1dd5_hd.jpg)# 分布式事务
- XA协议(两阶段提交、三阶段提交)


- TCC （两阶段型、补偿型）
- 最大努力通知（非可靠消息 、定期校对）
- 可靠消息最终一致（异步确何型）
-----------

## XA协议两阶段提交
#### 角色
> 中心单点协调者、分节点多参与者

#### 流程
> 第一阶段：协调者通知各参与者准备，各参与者锁住资源，执行操作并记入undo、redo，等待协调者 第二阶段通知后提交
第二阶段：协调者收到所有参与者发回的反馈信息，如果都是Done则通知 各参与者 提交事务；如果不都是Done则通知 各参与者回滚事务；

- 第一阶段
 ![](/assets/640.webp)

- 第二阶段
![](/assets/641.webp)


#### 不足
- 性能问题
- 协调者单点故障问题
- 丢失消息导致的不一致问题


#### 性能问题
第一阶段后 各参与者 锁住资源，等待提交
只有当所有参与者准备完毕，事务协调者才会通知提交，参与者提交后才会释放资源，造成性能问题

#### 协调者单点故障问题
一旦事务协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务

#### 丢失消息导致的不一致问题
发生局部网络问题，一部分事务参与者收到了提交消息，另一部分事务参与者没收到提交消息，那么就导致了节点之间数据的不一致

-----------


## XA三阶段提交

XA三阶段提交在两阶段提交的基础上增加了CanCommit阶段，并且引入了超时机制。
一旦参与者迟迟没有接到协调者的commit请求，会自动进行本地commit
这样有效解决了协调者单点故障的问题，但是性能问题和不一致的问题仍然没有根本解决

-----------

## XA两阶段提交 VS 三阶段提交 总结
> 两阶段提交如果中心协调者节点挂掉，参与者收不到提交或是回滚通知，参与者会一直处于中间状态无法完成事务
> 三阶段提交引入了CanCommit阶段和超时机制，解决了上面中心协调者节点挂掉，参与者无法完成事务的问题，超时自动进行本地commit


## TCC  https://www.liangzl.com/get-article-detail-525.html
TCC事务是Try、Commit、Cancel三种指令的缩写，其逻辑模式类似于XA两阶段提交，
但是实现方式是在代码层面来人为实现TCC里对每个服务资源操作的是本地事务，数据被lock的时间短，可扩展性好

- Try：预留业务资源/数据效验（如创建待处理的订单、先冻结账户的金额等）
- Confirm：确认执行业务操作（每个Confirm都得幂等操作）
- Cancel：取消执行业务操作 （每个Cancel都得幂等操作）

> 当try阶段协调者，收到所有参与者的回复都为success，则调用Confirm确认执行业务操作；
如果不都为success，则调用Cancel取消执行业务操作


## 示例
- Try操作
tryX 下单系统创建待支付订单
tryY 冻结账户红包200元
tryZ 冻结资金账户800元

- Confirm操作
confirmX 订单更新为支付成功
confirmY 扣减账户红包200元
confirmZ 扣减资金账户800元

- Cancel操作
cancelX 订单处理异常，资金红包退回，订单支付失败
cancelY 冻结红包失败，账户余额退回，订单支付失败
cancelZ 冻结余额失败，账户红包退回，订单支付失败


![](/assets/20180604001625_695.jpg)

![](/assets/v2-079e51cc1d398c96a8d321d0653d1dd5_hd.jpg)




当try方法的AOP切面有异常的时候，采用线程池异步去执行cancel，无异常的时候去执行confrim方法。

## 这里有人可能会问：那么cancel方法异常，或者confrim方法异常怎么办呢？
答：首先这种情况是非常罕见的，因为你上一面才刚刚执行完try。其次如果出现这种情况，在try阶段会保存好日志，Hmily有内置的调度线程池来进行恢复，定时作业轮询恢复调用confrim

## 有人又会问：这里如果日志保存异常了怎么办？
答：首先这又是一个牛角尖问题，首先日志配置的参数，在框架启动的时候，会要求你配置的。其次，就算在运行过程中日志保存异常，这时候框架会取缓存中的，并不会影响程序正确执行。最后，万一日志保存异常了，系统又在很极端的情况下down机了，恭喜你，你可以去买彩票了，最好的解决办法就是不去解决它
通过日志自动化处理 或人工干预处理



## 最大努力通知
#### 方案特点
• 业务活动的主动方在完成业务处理后，向业务活动被动方发送通知消息（允许消息丢失）
• 主动方可以设置时间阶梯型通知规则，在通知失败后按规则重复通知，直到通知N次后不再通知
• 主动方提供校对查询接口给被动方按需校对查询，用于恢复丢失的业务消息
#### 行业应用案例
• 银行通知、商户通知等（各大交易业务平台间的商户通知：多次通知、查询校对、对账文件）




# 分布式可靠消息

![](/assets/hello.PNG)

有两个问题：1.消息状态确认 2.消息恢复
轮询从业务方读取状态并更新


![](/assets/shiwu.PNG)

我的文档：第40： 2017年7月最新微服务架构的分布式事务解决方案价值1399


# 分布式最大努力型
也就是将可靠消息的 （请求发送、确认发送、取消发送）部分 替换为 在业务处理服务的本地数据库消息表中，其他消息确认系统，和消息恢复（定时检查）不变