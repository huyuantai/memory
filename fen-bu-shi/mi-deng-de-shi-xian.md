https://825635381.iteye.com/blog/2276077

https://mp.weixin.qq.com/s?__biz=MjM5ODYxMDA5OQ==&mid=2651960002&idx=1&sn=c0775231bccf002c3178eabe43f1cdcb&chksm=bd2d071e8a5a8e08c3a5287247ea41dee6b2621e6ffafbf909ec1e8a866b7c816eeeea227246&scene=21#wechat_redirect
消息总线真的能保证幂等

# 幂等
- 系统中有很多操作，是不管做多少次，都应该产生一样的效果或返回一样的结果

# 例如

- 前端重复提交选中的数据，应该后台只产生对应这个数据的一个反应结果。 
- 我们发起一笔付款请求，应该只扣用户账户一次钱，当遇到网络重发或系统bug重发，也应该只扣一次钱； 
- 发送消息，也应该只发一次，同样的短信发给用户，用户会哭的； 
- 创建业务订单，一次业务请求只能创建一个，创建多个就会出大问题

# 幂等的保证如下

- 查询
> 查询一次和查询多次，在数据不变的情况下，查询结果是一样的。select是天然的幂等操作 
-----
- 删除
> 删除也是幂等的，删除一次和多次删除都是把数据删除
-----
- 唯一索引，防止新增脏数据 
> 只能插入一条数据
  当表存在唯一索引，并发时新增报错时，再查询一次就可以了，数据应该已经存在了，返回结果即可
-----
- token机制，防止页面重复提交，幂等 
> 处理流程： 
1.数据提交前要向服务的申请token，token放到redis或jvm内存，token有效时间,token返回前端form中 
2.数据连同toke提交到后台，校验token，同时删除token，生成新的token返回 

#### 注意：redis要用删除操作来判断token，删除成功代表token校验通过，如果用select+delete来校验token，存在并发问题，不建议使用
-----


- 悲观锁 
> select * from table_xxx where id='xxx' for update; 

####  注意：id字段一定是主键或者唯一索引，不然是锁表，会死人的, 悲观锁使用时一般伴随事务一起使用，数据锁定时间可能会很长，根据实际情况选用 
-----

- 乐观锁

1.通过版本号实现 
update table_xxx set name=#name#,version=version+1 where version=#version# 
2. 通过条件限制 
update table_xxx set avai_amount=avai_amount-#subAmount# where avai_amount-#subAmount# >= 0 

####   注意：乐观锁的更新操作，最好用主键或者唯一索引来更新,这样是行锁，否则更新时会锁表，上面两个sql改成下面的两个更好 
update table_xxx set name=#name#,version=version+1 where id=#id# and version=#version# 
update table_xxx set avai_amount=avai_amount-#subAmount# where id=#id# and avai_amount-#subAmount# >= 0 

-----

- 分布式锁(redis,zookeeper)
-----


- select + insert 

并发不高的后台系统，或者一些任务JOB，为了支持幂等，支持重复执行，简单的处理方法是，先查询下一些关键数据，判断是否已经执行过，在进行业务处理，就可以了 
注意：核心高并发流程不要用这种方法 

-----

- 状态机幂等 

在设计单据相关的业务，或者是任务相关的业务，肯定会涉及到状态机(状态变更图)，就是业务单据上面有个状态，状态在不同的情况下会发生变更，一般情况下存在有限状态机，这时候，如果状态机已经处于下一个状态，这时候来了一个上一个状态的变更，理论上是不能够变更的，这样的话，保证了有限状态机的幂等。 

注意：订单等单据类业务，存在很长的状态流转，一定要深刻理解状态机，对业务系统设计能力提高有很大帮助 

-----

- 对外提供接口的api如何保证幂等 

如银联提供的付款接口：需要接入商户提交付款请求时附带：source来源，seq序列号 
source+seq在数据库里面做唯一索引，防止多次付款，(并发时，只能处理一个请求) 

重点： 
对外提供接口为了支持幂等调用，接口有两个字段必须传，一个是来源source，一个是来源方序列号seq，这个两个字段在提供方系统里面做联合唯一索引，这样当第三方调用时，先在本方系统里面查询一下，是否已经处理过，返回相应处理结果；没有处理过，进行相应处理，返回结果。注意，为了幂等友好，一定要先查询一下，是否处理过该笔业务，不查询直接插入业务系统，会报错，但实际已经处理了

-----



